!function(e){function t(t){var i=e(this).data("cbrepeat");if(!i)return!1;if(i.settings.max&&i.element.children(".cbRepeatRow").length>=i.settings.max)return!1;t||(t=i.element.children(".cbRepeatRow").last());var n=[];t.find("input:checked").each(function(){n.push(e(this))});var r=t.clone(!0);r.insertAfter(t);var s=r.find("*");return i.settings.ignore&&(s=s.not(i.settings.ignore)),s.each(function(){if(e(this).is("input,select,textarea")){var t=e(this).attr("type");"checkbox"==t||"radio"==t?"radio"==t&&2==e(this).siblings('input[type="radio"]').length+1&&0==e(this).val()?e(this).prop("checked",!0):e(this).prop("checked",!1):(e(this).val(""),e(this).is("select")&&(e(this).children('option[value=""]:first').length||e(this).val(e(this).children('option[value!=""]:first').val())))}e(this).triggerHandler("cloned",[e(this).data("orgId")]),e(this).is("input,select,textarea")&&e(this).trigger("change")}),a.call(this,i),e.each(n,function(e,t){t.prop("checked",!0)}),i.element.triggerHandler("cbrepeat.add",[i]),!0}function i(t){var i=e(this).data("cbrepeat");return i?i.settings.min&&i.element.children(".cbRepeatRow").length<=i.settings.min?!1:(t||(t=i.element.children(".cbRepeatRow").last()),t.remove(),a.call(this,i),i.element.triggerHandler("cbrepeat.remove",[i]),!0):!1}function a(t){var i=t.element.children(".cbRepeatRow");if(i.length>t.settings.min?(i.find(".cbRepeatRowMove,.cbRepeatRowRemove").filter(function(){return e(this).closest(".cbRepeatRow").is(i)}).removeClass("hidden"),t.settings.sortable&&t.element.sortable("enable")):(i.find(".cbRepeatRowMove,.cbRepeatRowRemove").filter(function(){return e(this).closest(".cbRepeatRow").is(i)}).addClass("hidden"),t.settings.sortable&&t.element.sortable("disable")),t.settings.max&&(i.length>=t.settings.max?i.find(".cbRepeatRowAdde").filter(function(){return e(this).closest(".cbRepeatRow").is(i)}).addClass("hidden"):i.find(".cbRepeatRowAdd").filter(function(){return e(this).closest(".cbRepeatRow").is(i)}).removeClass("hidden")),t.settings.sortable||i.find(".cbRepeatRowMove").filter(function(){return e(this).closest(".cbRepeatRow").is(i)}).addClass("hidden"),i.each(function(a){var n=e(this).find("*").filter(function(){return e(this).closest(".cbRepeatRow").is(i)});t.settings.ignore&&(n=n.not(t.settings.ignore)),n.each(function(){if(e(this).attr("id")){var i=e(this).attr("id");e(this).data("orgId")||e(this).data("orgId",e(this).attr("id")),e(this).attr("id",e(this).attr("id").replace(/^(.*__)(\d+)(__\w+)$/g,"$1"+a+"$3"));var n=e(this).attr("id");e(this).triggerHandler("modified",[i,n,a]);var r=i.replace("cbfr_","").replace("cbfv_","").replace(/__[a-zA-Z0-9]+$/g,""),s=n.replace("cbfr_","").replace("cbfv_","").replace(/__[a-zA-Z0-9]+$/g,""),c=e(this).closest(".cbRepeatRow").find("*[id]");t.settings.ignore&&(c=c.not(t.settings.ignore)),c.each(function(){var t=e(this).attr("id");e(this).data("orgId")||e(this).data("orgId",e(this).attr("id")),e(this).attr("id",e(this).attr("id").replace(r,s).replace(r.replace(/_{2,}/g,"__"),s.replace(/_{2,}/g,"__")));var i=e(this).attr("id");if("undefined"!=typeof cbHideFields){var n=[];e.each(cbHideFields,function(e,i){(i[0]==t||i[1]==t)&&n.push(i)}),e.each(n,function(t,i){var a=[];a[0]=i[0].replace(r,s).replace(r.replace(/_{2,}/g,"__"),s.replace(/_{2,}/g,"__")),a[1]=i[1].replace(r,s).replace(r.replace(/_{2,}/g,"__"),s.replace(/_{2,}/g,"__")),a[2]=i[2],a[3]=i[3],a[4]=[],e.each(i[4],function(e,t){a[4].push(t.replace(r,s).replace(r.replace(/_{2,}/g,"__"),s.replace(/_{2,}/g,"__")))}),a[5]=[],e.each(i[5],function(e,t){a[5].push(t.replace(r,s).replace(r.replace(/_{2,}/g,"__"),s.replace(/_{2,}/g,"__")))});var n=!1;e.each(cbHideFields,function(e,t){t[0]==a[0]&&t[1]==a[1]&&t[2]==a[2]&&t[3]==a[3]&&(n=!0)}),n||cbHideFields.push(a)})}e(this).triggerHandler("modified",[t,i,a])})}if(e(this).attr("for")){var o=e(this).attr("for").replace(/__[a-zA-Z0-9]+$/g,"");e(this).data("orgFor")||e(this).data("orgFor",e(this).attr("for")),e(this).attr("for",e(this).attr("for").replace(/^(.*__)(\d+)(__\w+)$/g,"$1"+a+"$3"));var l=e(this).attr("for").replace(/__[a-zA-Z0-9]+$/g,""),d=e(this).closest(".cbRepeatRow").find("*[for]");t.settings.ignore&&(d=d.not(t.settings.ignore)),d.each(function(){e(this).attr("for",e(this).attr("for").replace(o,l))})}if(e(this).attr("name")){var p=e(this).attr("name").replace(/\[[a-zA-Z0-9]+\]$/g,"");e(this).data("orgName")||e(this).data("orgName",e(this).attr("name")),e(this).attr("name",e(this).attr("name").replace(/^(.*)(\[\d+\])(\[\w+\])$/g,"$1["+a+"]$3"));var h=e(this).attr("name").replace(/\[[a-zA-Z0-9]+\]$/g,""),f=e(this).closest(".cbRepeatRow").find("*[name]");t.settings.ignore&&(f=f.not(t.settings.ignore)),f.each(function(){e(this).attr("name",e(this).attr("name").replace(p,h))})}})}),"undefined"!=typeof cbHideFields){var a=[];e.each(cbHideFields,function(t,i){e("#"+i[0]).length||a.push(i)}),e.each(a,function(e,t){cbHideFields.splice(cbHideFields.indexOf(t),1)})}"undefined"!=typeof cbInitFields&&cbInitFields(),t.element.triggerHandler("cbrepeat.updated",[t])}var n=[],r={init:function(r){return this.each(function(){var s=this,c=e(s).data("cbrepeat");c||(c={},c.options=r,c.defaults=e.fn.cbrepeat.defaults,c.settings=e.extend(!0,{},c.defaults,c.options),c.element=e(s),c.settings.useData&&e.each(c.defaults,function(e){if("init"!=e&&"useData"!=e){var t=c.element.data("cbrepeat"+e.charAt(0).toUpperCase()+e.slice(1));"undefined"!=typeof t?c.settings[e]=t:(t=c.element.data("cbrepeat"+e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()),"undefined"!=typeof t&&(c.settings[e]=t))}}),c.settings.min||(c.settings.min=1),c.element.triggerHandler("cbrepeat.init.before",[c]),c.settings.init&&(c.settings.sortable&&c.element.sortable({placeholder:c.element.children(".cbRepeatRow").first().attr("class")+" cbRepeatRowPlaceholder",forcePlaceholderSize:!0,cursor:"move",items:".cbRepeatRow",containment:"parent",animated:!0,stop:function(t,i){var n=[];c.element.children(".cbRepeatRow").find("input:checked").each(function(){n.push(e(this))}),a.call(s,c),e.each(n,function(e,t){t.prop("checked",!0)}),c.element.triggerHandler("cbrepeat.move",[c,t,i])},tolerance:"pointer",handle:".cbRepeatRowMove",opacity:.5}),c.addHandler=function(i){i.preventDefault();var a=e(this).closest(".cbRepeatRow");t.call(s,a)},c.settings.add&&c.element.find(".cbRepeatRowAdd").filter(function(){return e(this).closest(".cbRepeatRow").parent().is(c.element)}).on("click",c.addHandler),c.removeHandler=function(t){t.preventDefault();var a=e(this).closest(".cbRepeatRow");i.call(s,a)},c.settings.remove&&c.element.find(".cbRepeatRowRemove").filter(function(){return e(this).closest(".cbRepeatRow").parent().is(c.element)}).on("click",c.removeHandler),a.call(s,c),c.element.on("modified.cbrepeat",function(e,t,i,a){i!=a&&(c.element.cbrepeat("cbrepeat"),c.element.cbrepeat(c.options))}),c.element.bind("cloned.cbrepeat",function(){e(this).off("cloned.cbrepeat"),e(this).off("modified.cbrepeat"),e(this).removeData("cbrepeat"),e(this).removeData("uiSortable");var t=e(this).find(".cbRepeatRow").first().parent();e(this).find(".cbRepeatRowAdd").filter(function(){return e(this).closest(".cbRepeatRow").parent().is(t)}).off("click",c.addHandler),e(this).find(".cbRepeatRowRemove").filter(function(){return e(this).closest(".cbRepeatRow").parent().is(t)}).off("click",c.removeHandler),e(this).cbrepeat(c.options)}),c.element.triggerHandler("cbrepeat.init.after",[c]),c.element.data("cbrepeat",c),n.push(c)))})},add:function(e){return t.call(this,e),!0},remove:function(e){return i.call(this,e),!0},update:function(){var t=e(this).data("cbrepeat");return t?(a.call(this,t),!0):!1},destroy:function(){var t=e(this).data("cbrepeat");return t?(t.settings.sortable&&(t.element.sortable("destroy"),t.element.removeData("uiSortable")),t.element.find(".cbRepeatRowAdd").filter(function(){return e(this).closest(".cbRepeatRow").parent().is(t.element)}).off("click",t.addHandler),t.element.find(".cbRepeatRowRemove").filter(function(){return e(this).closest(".cbRepeatRow").parent().is(t.element)}).off("click",t.removeHandler),t.element.off("cloned.cbrepeat"),t.element.off("modified.cbrepeat"),e.each(n,function(e,i){return i.element==t.element?(n.splice(e,1),!1):!0}),t.element.removeData("cbrepeat"),t.element.triggerHandler("cbrepeat.destroyed",[t]),!0):!1},instances:function(){return n}};e.fn.cbrepeat=function(e){return r[e]?r[e].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof e&&e?this:r.init.apply(this,arguments)},e.fn.cbrepeat.defaults={init:!0,useData:!0,sortable:!0,ignore:null,add:!0,remove:!0,min:1,max:0}}(jQuery);